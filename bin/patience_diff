#!/usr/bin/env ruby
require 'English'
require 'trollop'

lib_path = File.expand_path(File.join(File.dirname(__FILE__),"..","lib"))
$LOAD_PATH.unshift(lib_path)
require 'patience_diff'

begin
  opts = Trollop::options do
    banner <<-EOF
Usage: #{File.basename($0)} [options] left-file right-file
Options:
EOF
    version "patience_diff #{PatienceDiff::VERSION}"
    opt :debug, "Debugging mode"
    opt :context, "Lines of context", :default => 3
    opt :full_context, "Don't collapse common sections; output entire files"
  end
  
  raise PatienceDiff::UsageError unless ARGV.length == 2
  
  left_file, right_file = *ARGV
  
  left = File.read(left_file, :external_encoding => Encoding::BINARY).split($RS)
  left_timestamp = File.mtime(left_file)
  right = File.read(right_file, :external_encoding => Encoding::BINARY).split($RS)
  right_timestamp = File.mtime(right_file)
  
  opts[:no_grouping] = opts[:full_context]
  formatter = PatienceDiff::UnifiedDiffer.new(opts)
  puts formatter.diff(left, right, left_file, right_file, left_timestamp, right_timestamp)
  
rescue PatienceDiff::UsageError => e
  Trollop.module_eval do
    @last_parser.educate($stderr)
  end
rescue StandardError => e
  if opts[:debug]
    raise
  else
    $stderr.puts "Error: #{e}"
  end
end
